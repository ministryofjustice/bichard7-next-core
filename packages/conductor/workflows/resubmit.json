{
  "name": "resubmit",
  "description": "Case Resubmission",
  "version": 3,
  "schemaVersion": 2,
  "tasks": [
    {
      "name": "check_db",
      "taskReferenceName": "check_db_ref",
      "inputParameters": {
        "autoResubmit": "${workflow.input.autoResubmit}",
        "messageId": "${workflow.input.messageId}"
      },
      "type": "SIMPLE"
    },
    {
      "name": "check_output",
      "taskReferenceName": "switch_auto_failed_ref",
      "inputParameters": {
        "autoFailed": "${check_db_ref.output.autoFailed}"
      },
      "type": "SWITCH",
      "evaluatorType": "value-param",
      "expression": "autoFailed",
      "decisionCases": {
        "true": [
          {
            "name": "terminate",
            "taskReferenceName": "terminate_auto_failed_ref",
            "inputParameters": {
              "terminationStatus": "COMPLETED",
              "workflowOutput": {
                "errorMessage": "${check_db_ref.output.errorMessage}",
                "reason": "Auto Resubmission failed"
              }
            },
            "type": "TERMINATE"
          }
        ]
      },
      "defaultCase": [
        {
          "name": "lock_s3_file",
          "taskReferenceName": "lock_s3_file_ref",
          "inputParameters": {
            "bucketId": "task-data",
            "fileName": "${check_db_ref.output.s3TaskDataPath}",
            "lockId": "${workflow.workflowId}"
          },
          "type": "SIMPLE"
        },
        {
          "name": "check_lock",
          "taskReferenceName": "switch_check_lock_ref",
          "inputParameters": {
            "lockState": "${lock_s3_file_ref.output.lockState}"
          },
          "type": "SWITCH",
          "evaluatorType": "value-param",
          "expression": "lockState",
          "decisionCases": {
            "failure": [
              {
                "name": "terminate",
                "taskReferenceName": "terminate_lock_failure_ref",
                "inputParameters": {
                  "terminationStatus": "COMPLETED",
                  "workflowOutput": { "reason": "lock acquisition failed" }
                },
                "type": "TERMINATE"
              }
            ]
          },
          "defaultCase": [
            {
              "name": "process_resubmit",
              "taskReferenceName": "process_resubmit_ref",
              "inputParameters": {
                "s3TaskDataPath": "${check_db_ref.output.s3TaskDataPath}"
              },
              "type": "SIMPLE"
            },
            {
              "name": "store_audit_log_events",
              "taskReferenceName": "store_audit_log_ref",
              "inputParameters": {
                "correlationId": "${workflow.correlationId}",
                "auditLogEvents": "${process_resubmit_ref.output.auditLogEvents}"
              },
              "type": "SIMPLE"
            },
            {
              "name": "switch_on_phase",
              "taskReferenceName": "switch_phase_ref",
              "inputParameters": {
                "phase": "${process_resubmit_ref.output.currentPhase}"
              },
              "type": "SWITCH",
              "evaluatorType": "value-param",
              "expression": "phase",
              "decisionCases": {
                "1": [
                  {
                    "name": "start_workflow",
                    "taskReferenceName": "start_bichard_p1_ref",
                    "type": "START_WORKFLOW",
                    "inputParameters": {
                      "startWorkflow": {
                        "name": "bichard_phase_1",
                        "version": 1,
                        "input": {
                          "s3TaskDataPath": "${process_resubmit_ref.output.s3TaskDataPath}"
                        }
                      }
                    }
                  }
                ],
                "2": [
                  {
                    "name": "start_workflow",
                    "taskReferenceName": "start_bichard_p2_ref",
                    "type": "START_WORKFLOW",
                    "inputParameters": {
                      "startWorkflow": {
                        "name": "bichard_phase_2",
                        "version": 1,
                        "input": {
                          "s3TaskDataPath": "${process_resubmit_ref.output.s3TaskDataPath}"
                        }
                      }
                    }
                  }
                ]
              }
            }
          ]
        }
      ]
    }
  ],
  "inputParameters": ["autoResubmit", "messageId"],
  "outputParameters": {},
  "restartable": true,
  "workflowStatusListenerEnabled": false,
  "timeoutPolicy": "ALERT_ONLY",
  "timeoutSeconds": 0
}
