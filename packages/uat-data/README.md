# UAT Scenarios<!-- omit from toc -->

The purpose of these scenarios is to populate the UAT environment with realistic looking cases.

## Contents<!-- omit from toc -->

- [Seeding local Environment](#seeding-local-environment)
- [Seeding UAT Environment](#seeding-uat-environment)
- [Find a Matching Scenario](#find-a-matching-scenario)
- [Retrieving Original Message](#retrieving-original-message)
- [Retrieving PNC Response](#retrieving-pnc-response)
- [Anonymising Data](#anonymising-data)
  - [Anonymising Incoming Message](#anonymising-incoming-message)
  - [Anonymising PNC Response](#anonymising-pnc-response)

## Seeding local Environment

```bash
AWS_URL=http://localhost:4566 REPEAT_SCENARIOS=1 DEPLOY_NAME=uat npx ts-node scripts/insert-uat-data.ts
```

## Seeding UAT Environment

```bash
S3_INCOMING_MESSAGE_BUCKET=bichard-7-uat-incoming-messages PNC_HOST=cjse-uat-bichard-7-pnc-emulator-75e8686f94f102b8.elb.eu-west-2.amazonaws.com PNC_PORT=3000 DEPLOY_NAME=uat REPEAT_SCENARIOS=1 aws-vault exec bichard7-shared-load-test -- npx ts-node scripts/insert-uat-data.ts
```

## Find a Matching Scenario

Connect to the (read-only replica) production database, and find a case with the desired trigger/exception.

Run the following sql, replacing `REASON_CODE` with your required reason code. Make sure to leave the `%` either side of your reason code.

```sql
SELECT
 *
FROM
 br7own.error_list
WHERE error_report LIKE '%REASON_CODE%' and error_count != 0
ORDER BY
 error_id DESC
LIMIT 10;
```

Select a case from the results, and make a note of the `message_id`.

## Retrieving Original Message

Create a new folder in `scripts/uat-data/`. The name should be the trigger code this scenario exemplifies, eg `scripts/uat-data/HO100323`. Create two files inside this new folder, `incoming-messages.xml` and `pnc-data.xml`. Leave them blank for now.

Log into the AWS console for the `production` environment. Navigate to `DynamoDB` and open the `bichard-7-production-audit-log` table. Query the `message_id` of your selected case. Make a note of the `s3Path` for your case.

Navigate to `s3`, open `bichard-7-production-conductor-internal-incoming-messages` and search for the `s3Path` from `DynamoDB`. Down load the message xml file.

Transfer the contents to your `incomming-message.xml` file, and delete the original file (make sure to remove it from the recyling bin as well).

:warning: Do not commit your work until you have finished anonymising the `incoming-message` and `pnc-data` files!

## Retrieving PNC Response

Go back to `DynamoDB` and open the `bichard-7-production-audit-log-events`. Use the `messageIdIndex` to query the `message_id`. Check the `eventCode` column for a `pnc.response-received` event. The event source should be `PNC Access Manager`.

Click into the event, and copy the xml from the `PNC Response Message` field. Paste this into your `pnc-data` file. You can run it through an xml formatter to make it easier to read. Check that the first line is capitalised the same way as other `pnc-message` files.

:warning: Do not commit this file until it has been anonymised!

## Anonymising Data

Scenarios are given random names and addresses by the `insert-uat-data` script. The script does a simple string replacement with values generated by `Faker.js`.

To avoid committing `PII` to github, you will need to go through the incoming message and replace any identifyable fields with markers for the seed script to replace.

The seed script looks for the following strings to replace:

| String                  | Value                                  |
| ----------------------- | -------------------------------------- |
| EXTERNAL_CORRELATION_ID | A random UUID                          |
| COURT_LOCATION          | A random court code                    |
| DATE_OF_HEARING         | The current date                       |
| PROSECUTOR_REFERENCE    | An incrementally generated ASN         |
| PNC_IDENTIFIER          | "20230012345P"                         |
| _PTIURN_                | "01XX" + random 7 digit number         |
| GIVEN_NAME              | A random first name                    |
| FAMILY_NAME             | A random surname                       |
| DATE_OF_BIRTH           | "1983-03-11"                           |
| ADDRESS_LINE_1          | A random street and house number       |
| ADDRESS_LINE_2          | A random street name                   |
| ADDRESS_LINE_3          | A random city                          |
| ADDRESS_LINE_4          | A random county                        |
| ADDRESS_LINE_5          | A random postcode                      |
| OFFENCE_LOCATION        | A random address, cut to 80 characters |
| VICTIM\_\*              | A random name                          |

### Anonymising Incoming Message

- Replace the value of `<CorrelationID>` with `EXTERNAL_CORRELATION_ID`

The message content is contained within the `<ns2:DataStreamContent>` tag. To make editing easier, copy the value of this tag to a new file and run it through an xml formatter.

The xml in the data stream content may have been escaped by replacing `<` with `&lt;` and `>` with `&gt;`. You can use a find/replace to change the message content back to xml.

Replace the following fields:

- Replace the value of `<CourtHearingLocation>` with `COURT_LOCATION`
- Replace the value of `<DateOfHearing>` with `DATE_OF_HEARING`
- Replace the value of `<PTIURN>` with `_PTIURN_`
- Replace the value of `<ProsecutorReference>` with `PROSECUTOR_REFERENCE`
- Replace the value of `<PersonGivenName1>` with `GIVEN_NAME` - Replace any additional given names with the same string
- Replace the value of `<PersonFamilyName>` with `FAMILY_NAME`
- Replace the value of `<Birthdate>` with `DATE_OF_BIRTH`
- Replace the value of `<PNCidentifier>` with `PNC_IDENTIFIER`
- Replace the values of `<AddressLine1>` through `<AddressLine5>` with the appropriate `ADDRESS_LINE_*` string
- Check any `<OffenceWording>` for names or addresses, replace with appropriate strings for the seed script to replace.
  - Names other than the defendant can be replaced with `VICTIM_1`, `VICTIM_2` etc.
- Replace any `<ConvictionDate>` tags with `DATE_OF_HEARING`

Once finished, It is a good idea to have another team member check over the xml in case anything has been missed. Do this via screen share, do not send over slack or email.

Once you are confident that no `PII` remains, minify the xml, escape it (even if it wasn't originally), and paste back into the `incoming-message` file.

### Anonymising PNC Response

- Replace the value of `<FSC>` with `K01XM`
- Replace the value of `<IDS>` with `K00/000000X FAMILY_NAME`

Once these two files have bend anonymised, you can use your local dev environment to check that they produce the type of exceptions/triggers that you expect. Note that these fields are expected to be a specific length. If you encounter errors in testing, double check there is no extra whitespace in these values.
